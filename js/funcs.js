!function(){function t(){var t=null,i=null,e=null,n=null,o=0,s=function(t){return"M 0 0 m -"+t+", 0 a "+t+","+t+" 0 1,0 "+2*t+",0 a "+t+","+t+" 0 1,0 -"+2*t+",0"},r=function(){return"m-16,0 a16,5 0 1 0 32,0 l-11,-24 a12.5,12.5 0 1 0 -6,0 l-14,25"},a=function(t,i){var e=t.lat()-i.lat(),n=t.lng()-i.lng(),o=(Math.abs(e)+Math.abs(n))/2,s=10>o?1>o?.1>o?.01>o?.001>o?1e-4>o?3:6:9:12:15:24:21,r=e/s,a=n/s;return Math.abs(r)>0||Math.abs(a)>0?{unit:s,lat:r,lng:a}:null},l=function(i,e,n,o,s){o>n?(t.setCenter(new google.maps.LatLng(t.getCenter().lat()+i,t.getCenter().lng()+e)),setTimeout(function(){l(i,e,n+1,o,s)},50)):s&&s()},h=function(i,e){var n=t.getCenter(),o=a(i,n);return o?(l(o.lat,o.lng,0,o.unit,e),void 0):!1},g=function(){var t=new Date;return t.getHours()+":"+t.getMinutes()+":"+t.getSeconds()},u=function(t,i){if(n&&t){"title"===i?n.append($("<div />").addClass("title").text(t)):n.append($("<div />").addClass("log").append($("<div />").addClass("l").text(t)).append($("<div />").addClass("r").text(g())));var e=n.get(0);e.scrollTop=e.scrollHeight}};this.logs=u,this.initMap=function(i,e){return e=$.extend({zoom:16,scaleControl:!0,navigationControl:!1,disableDoubleClickZoom:!0,mapTypeControl:!1,zoomControl:!1,scrollwheel:!1,streetViewControl:!1,center:new google.maps.LatLng(23.568038757736595,120.30465692281723)},e),t=new google.maps.Map(i.get(0),e),this},this.markerInfoToBuild=function(i){this.layer+=1;var e=(360+google.maps.geometry.spherical.computeHeading(this.getPosition(),this.prev.getPosition()))%360,n=(360+google.maps.geometry.spherical.computeHeading(this.getPosition(),this.next.getPosition()))%360,o=Math.abs(n-e);return o=180>o?Math.max(e,n)+(360-o)/2:Math.min(e,n)+o/2,this.build&&this.build.setMap(null),this.build=new google.maps.Marker({map:t,draggable:!1,position:google.maps.geometry.spherical.computeOffset(this.getPosition(),80,o),icon:"img/map/build/h"+i.id+"_"+this.layer+".png"}),!0},this.initMarkerInfos=function(e){var n=this;return i=e.map(function(i,o){return i.i=o,i.next=e[(o+1)%e.length],i.prev=e[(o+e.length-1)%e.length],i.userCount=0,i.getPosition=function(){return this.position},i.setPosition=function(t){return this.marker&&this.marker.setPosition(t),this},i.owner=null,i.price=i.price,i.title=i.title,i.layer=0,i.toBuild=n.markerInfoToBuild,i.marker=new google.maps.Marker({map:t,draggable:!1,position:i.position,icon:{path:s(20),strokeColor:"rgba(50, 60, 140, 1)",strokeWeight:1,fillColor:"rgba(68, 77, 145, .85)",fillOpacity:.5}}),i}),this},this.initPolyline=function(){return e=new google.maps.Polyline({map:t,path:i.map(function(t){return t.marker.getPosition()}).concat([i[0].marker.getPosition()]),strokeColor:"rgba(102, 217, 239, .5)",strokeWeight:10}),this},this.init=function(o,s,r){try{return this.initMap(o).initMarkerInfos(s).initPolyline(),r&&(n=r),t&&i&&e?!0:!1}catch(a){return!1}},this.setUserPosition=function(t){if(t)return this.marker.setPosition(t),this;if(!i[this.index])return!1;switch(i[this.index].userCount){case 0:t=new google.maps.LatLng(i[this.index].getPosition().lat(),i[this.index].getPosition().lng());break;case 1:t=new google.maps.LatLng(i[this.index].getPosition().lat(),i[this.index].getPosition().lng()+5e-4);break;case 2:t=new google.maps.LatLng(i[this.index].getPosition().lat(),i[this.index].getPosition().lng()-5e-4);break;case 3:t=new google.maps.LatLng(i[this.index].getPosition().lat()+5e-4,i[this.index].getPosition().lng());break;case 4:t=new google.maps.LatLng(i[this.index].getPosition().lat()-5e-4,i[this.index].getPosition().lng())}return t?(this.marker.setPosition(t),i[this.index].userCount+=1,this):!1},this.userBuyStep=function(t){return i[this.index].owner&&i[this.index].owner!=this?!1:t||confirm((i[this.index].layer?"是否加蓋":"是否購買")+i[this.index].title+"("+i[this.index].price+"元)？")?this.quotaObj.text()<i[this.index].price?(u(this.name+" 錢不夠，哭哭.."),!0):(i[this.index].toBuild(this)||(alert("系統錯誤！"),location.reload()),i[this.index].owner=this,this.quotaObj.text(this.quotaObj.text()-i[this.index].price),i[this.index].layer>1?u(this.name+" 房子加蓋了一層！"):u(this.name+" 蓋了一棟房子！"),!0):(i[this.index].owner=null,u(this.name+" 取消"+(i[this.index].layer?"加蓋":"購買")+i[this.index].title+"！"),!1)},this.userPayStep=function(){if(!i[this.index].owner||i[this.index].owner==this)return!1;var t=parseInt(i[this.index].layer*i[this.index].price,10);this.quotaObj.text()<t?(alert(this.name+" 破產了！"),location.reload()):(this.quotaObj.text(this.quotaObj.text()-t),i[this.index].owner.quotaObj.text(parseInt(i[this.index].owner.quotaObj.text(),10)+t),u(this.name+" 付給了 "+i[this.index].owner.name+" 過路費 "+t+"元！"))},this.userGoStop=function(t,e){return this.setPosition(),h(this.getPosition(),function(i){i.owner&&i.owner!=this?this.payStep():this.buyStep(t?t:!1),e&&e()}.bind(this,i[this.index])),!0},this.userMove=function(t,e,n,o,s,r,a){return o>=s?(this.index=(this.index+1)%i.length,t>1?this.goStep(t-1,r,a):this.goStop(r,a)):(this.setPosition(new google.maps.LatLng(this.getPosition().lat()+e,this.getPosition().lng()+n)),setTimeout(function(){this.move(t,e,n,o+1,s,r,a)}.bind(this),50),void 0)},this.userGoStep=function(t,e,n){if(1>t)return!1;var o=this.getPosition(),s=i[(this.index+1)%i.length].getPosition(),r=a(s,o);return r?(i[this.index].userCount-=1,this.move(t,r.lat,r.lng,0,r.unit,e,n),void 0):!1},this.createUser=function(i,e,n){return{id:o++,index:0,name:i,quotaObj:e,move:this.userMove,goStep:this.userGoStep,goStop:this.userGoStop,buyStep:this.userBuyStep,payStep:this.userPayStep,setPosition:this.setUserPosition,getPosition:function(){return this.marker?this.marker.getPosition():null},marker:new google.maps.Marker({map:t,draggable:!1,icon:{path:r(),strokeColor:n,strokeWeight:1,fillColor:n,fillOpacity:.5}})}}}window.funcs=t}();